<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap 5.3 (unified with index) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" crossorigin="anonymous">
  <!-- link to style sheet -->
  <link rel="stylesheet" href="../style.css">
  <!-- LINK TO PROJECT PAGE STYLE SHEET -->
    <link rel="stylesheet" href="../pag_proyecto.css">
  <!-- GOOGLE fonts: Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
  
    <title>Proyecto 2</title>
    
    <style>
        /* Layout espec√≠fico para p√°gina de mapas */
        .page-wrapper {
            padding-top: 100px; /* Espacio entre navbar y mapas */
            padding-bottom: 20px;
        }
        
        .maps-section {
            display: flex;
            gap: 25px;
            max-width: 1400px; /* Aumentar ancho m√°ximo */
            margin: 0 auto 25px auto; /* Reducir dr√°sticamente el gap debajo */
            padding: 0 15px; /* Reducir padding para dar m√°s espacio a los mapas */
        }
        
        .map-column {
            flex: 1;
            min-width: 0;
        }
        
        .map-container {
            width: 100%;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-top: 0.5rem;
        }
        
        #leafletMap {
            height: 650px; /* Aumentar altura */
            width: 100%;
        }
        
        .map-title {
            text-align: center;
            font-size: 1.4rem; /* Aumentar tama√±o */
            font-weight: 600;
            margin: 0 0 1rem 0;
            color: #333;
            font-family: 'Noto Sans', sans-serif;
        }
        
        /* Contenido del proyecto */
        .project-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: center; /* Centrar horizontalmente */
        }
        
        .project-content .project-text {
            width: 100%;
            margin: 0; /* Eliminar m√°rgenes autom√°ticos del CSS original */
            text-align: center; /* Centrar el contenido */
        }
        
        .project-content .project-text .indent {
            text-align: justify; /* Justificar solo los p√°rrafos de contenido */
            display: block;
            margin: 0.5rem 0;
        }
        
        /* Estilos para la leyenda */
        .legend {
            line-height: 20px;
            color: #555;
            background: white;
            background: rgba(255,255,255,0.95);
            border-radius: 8px;
            padding: 12px 16px;
            font: 13px/16px Arial, Helvetica, sans-serif;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            border: 1px solid #ccc;
            min-width: 160px; /* Aumentar ancho m√≠nimo */
        }
        .legend i {
            width: 20px;
            height: 20px;
            float: left;
            margin-right: 10px;
            margin-bottom: 4px;
            opacity: 0.8;
            border: 1px solid #999;
            border-radius: 2px;
        }
        .legend h6 {
            margin: 0 0 8px 0;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            color: #333;
        }
        .legend .legend-item {
            display: block;
            clear: both;
            margin-bottom: 4px;
            font-size: 12px;
            line-height: 20px;
        }
        
        /* Responsive para m√≥viles */
        @media (max-width: 768px) {
            .page-wrapper {
                padding-top: 70px;
            }
            .maps-section {
                flex-direction: column;
                gap: 30px;
                margin-bottom: 5px; /* Reducir tambi√©n en m√≥viles */
                padding: 0 10px;
            }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="container">
            <div class="logo">
                <a href="../index.html">Inicio</a>
            </div>
            <div id="mainListDiv" class="main_list">
                <ul class="navlinks">
                    <li><a href="../index.html#cv">CV</a></li>
                    <li><a href="https://www.linkedin.com/in/tu-perfil/">LinkedIn</a></li>
                    <li><a href="https://github.com/luzarin">GitHub</a></li>
                </ul>
            </div>
            <button id="mobileMenuButton" class="mobile-menu-btn" aria-label="Abrir men√∫">‚ò∞</button>
            <div id="mobileMenu" class="mobile-menu" style="display:none;">
              <ul>
                <li><a href="../index.html#cv">CV</a></li>
                <li><a href="https://www.linkedin.com/in/tu-perfil/">LinkedIn</a></li>
                <li><a href="https://github.com/luzarin">GitHub</a></li>
              </ul>
            </div>
        </div>
    </nav>

    <div class="page-wrapper">
        <!-- Container for the maps side by side -->
        <div class="maps-section">
            <!-- Columna izquierda: Mapa de Leaflet -->
            <div class="map-column">
                <div class="map-title">Mapa de An√°lisis Espacial</div>
                <div class="map-container">
                    <div id="leafletMap"></div>
                </div>
            </div>
            
            <!-- Columna derecha: Mapa 3D -->
            <div class="map-column">
                <div class="map-title">Visualizaci√≥n 3D - Densidad UF/M¬≤</div>
                <div class="map-container">
                    <iframe src="proyecto 2/hexagonos_uf_3d.html" width="100%" height="650" style="border: none; border-radius: 6px;"></iframe>
                </div>
            </div>
        </div>

        <!-- Content container for project description -->
        <div class="project-content">
            <p class="card-text project-text"><span class="coll projdes">Resumen del Proyecto</span><br><span class="indent">Introducci√≥n.</span>
    <br>
    <span class="indent">
    Parrafo 2
    </span>
    <br>
    <span class="indent">
    Parrafo 3
    </span>
    <br><br>
    <span class="coll projdes">M√°s Informaci√≥n</span>
    <br><br>
    <a href="https://arcg.is/19fm1q">
        <span class="logos">üåç StoryMap</span>
    </a>
  <a href="#">
        <span class="logos">üìÑ Reporte Completo</span>
    </a>
    <a href="https://github.com/Alanrocks/Mangrove-Classification">
        <span class="logos">üîó GitHub</span>
    </a>
</p>
        </div>
    </div>

    <!-- FOOTER -->
    <footer style="background-color: #111111; padding: 20px 0; text-align: center; margin-top: 40px;">
        <p style="margin: 0; color: #ffffff; font-size: 0.95em;">
            Creado por Lucas Blachet Del Solar | Email: lucas.blachet@uc.cl
        </p>
    </footer>

  <!-- Leaflet JavaScript -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

  <!-- JAVASCRIPT FOR MAPS -->
  <script>
    // Variables globales
    var map;
    var hexagonosLayer;
    
    // Funci√≥n para obtener color basado en el valor UF/M¬≤ (usando los mismos rangos que tu mapa 3D)
    function getColor(valor) {
        if (valor <= 16) {
            return '#fff5f0';  // Blanco rosado claro
        } else if (valor <= 43) {
            return '#fcbea5';  // Rosa salm√≥n claro
        } else if (valor <= 68) {
            return '#fb7050';  // Naranja rojizo
        } else if (valor <= 126) {
            return '#d32020';  // Rojo intenso
        } else {  // > 126
            return '#67000d';  // Rojo muy oscuro
        }
    }
    
    // Funci√≥n para el estilo de cada hex√°gono
    function style(feature) {
        var valor = feature.properties['UF/M2 promedio'] || 0;
        return {
            fillColor: getColor(valor),
            weight: 0.5,
            opacity: 1,
            color: 'white',
            dashArray: '',
            fillOpacity: 0.8
        };
    }
    
    // Funci√≥n para destacar al pasar el mouse
    function highlightFeature(e) {
        var layer = e.target;
        layer.setStyle({
            weight: 3,
            color: '#666',
            dashArray: '',
            fillOpacity: 0.9
        });
        layer.bringToFront();
    }
    
    // Funci√≥n para resetear el estilo
    function resetHighlight(e) {
        hexagonosLayer.resetStyle(e.target);
    }
    
    // Funci√≥n para manejar el click en hex√°gonos
    function zoomToFeature(e) {
        var layer = e.target;
        var valor = layer.feature.properties['UF/M2 promedio'] || 0;
        
        // Mostrar popup con el valor
        layer.bindPopup(`
            <div style="text-align: center; font-family: 'Noto Sans', sans-serif;">
                <h6 style="margin: 0 0 8px 0; color: #2c3e50;"><strong>Valor UF/M¬≤</strong></h6>
                <p style="font-size: 18px; color: #e74c3c; margin: 0; font-weight: 600;">
                    ${valor.toFixed(2)} UF/M¬≤
                </p>
                <p style="font-size: 12px; color: #7f8c8d; margin: 4px 0 0 0;">
                    GRID ID: ${layer.feature.properties.GRID_ID || 'N/A'}
                </p>
            </div>
        `).openPopup();
    }
    
    // Funci√≥n para eventos de cada feature
    function onEachFeature(feature, layer) {
        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: zoomToFeature
        });
    }
    
    // Inicializar Leaflet Map
    function initLeafletMap() {
        // Crear el mapa centrado en el sector oriente de Santiago (desplazado hacia la derecha)
        map = L.map('leafletMap').setView([-33.4, -70.34], 14);
        
        // A√±adir capa base - Usando el mismo estilo que el mapa 3D (CartoDB Positron)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors ¬© CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        
        console.log('Mapa inicializado. Intentando cargar hex√°gonos...');
        
        // Cargar el GeoJSON con hex√°gonos
        fetch('proyecto 2/hexagonos_uf.geojson')
            .then(response => {
                console.log('Respuesta del fetch:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('üéØ GeoJSON cargado exitosamente!');
                console.log('üìä Datos recibidos:', data);
                console.log('üìç N√∫mero de hex√°gonos:', data.features ? data.features.length : 'Sin features');
                console.log('üó∫Ô∏è CRS del archivo:', data.crs);
                
                if (data.features && data.features.length > 0) {
                    console.log('üîç Primera feature de ejemplo:', data.features[0]);
                    console.log('üìù Propiedades:', data.features[0].properties);
                    console.log('üåç Geometr√≠a tipo:', data.features[0].geometry.type);
                    console.log('üìê Primeras coordenadas:', data.features[0].geometry.coordinates[0][0][0]);
                    
                    // Verificar si las coordenadas parecen estar en Web Mercator
                    var firstCoord = data.features[0].geometry.coordinates[0][0][0];
                    console.log('üìä An√°lisis de coordenadas:');
                    console.log('   X (longitud):', firstCoord[0]);
                    console.log('   Y (latitud):', firstCoord[1]);
                    
                    if (Math.abs(firstCoord[0]) > 1000000) {
                        console.log('‚ö†Ô∏è ADVERTENCIA: Las coordenadas parecen estar en metros (proyectadas)');
                        console.log('   Leaflet espera coordenadas geogr√°ficas (grados)');
                        
                        // Intentar transformar coordenadas Web Mercator a geogr√°ficas
                        console.log('üîÑ Intentando transformar coordenadas...');
                        transformAndAddLayer(data);
                    } else {
                        console.log('‚úÖ Las coordenadas parecen estar en grados');
                        addLayerToMap(data);
                    }
                } else {
                    console.error('‚ùå No hay features en el GeoJSON');
                }
            })
            .catch(error => {
                console.error('üí• Error cargando hex√°gonos:', error);
                // Mostrar un marcador de ejemplo si no se puede cargar el archivo
                L.marker([-33.4, -70.45]).addTo(map)
                    .bindPopup(`‚ùå Error: ${error.message}<br>Verifica que el archivo hexagonos_uf.geojson est√© en la carpeta proyectos`)
                    .openPopup();
            });
            
        // Agregar leyenda
        var legend = L.control({position: 'bottomright'});
        
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend'),
                grades = [0, 16, 43, 68, 126],
                labels = [];
            
            div.innerHTML = '<h6><strong>UF/M¬≤ Promedio</strong></h6>';
            
            // Crear entradas de leyenda ordenadas
            for (var i = 0; i < grades.length; i++) {
                var rangeText = grades[i] + (grades[i + 1] ? '‚Äì' + grades[i + 1] : '+');
                div.innerHTML +=
                    '<div class="legend-item">' +
                    '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                    rangeText +
                    '</div>';
            }
            
            return div;
        };
        
        legend.addTo(map);
    }
    
    // Funci√≥n para transformar coordenadas Web Mercator a geogr√°ficas
    function transformAndAddLayer(data) {
        console.log('üîÑ Transformando coordenadas de Web Mercator a geogr√°ficas...');
        
        // Funci√≥n para transformar un punto de Web Mercator a lat/lng
        function webMercatorToLatLng(x, y) {
            var lng = x / 20037508.34 * 180;
            var lat = y / 20037508.34 * 180;
            lat = 180 / Math.PI * (2 * Math.atan(Math.exp(lat * Math.PI / 180)) - Math.PI / 2);
            return [lng, lat];
        }
        
        // Transformar todas las coordenadas
        var transformedData = JSON.parse(JSON.stringify(data)); // Deep clone
        
        transformedData.features.forEach(function(feature, featureIndex) {
            if (feature.geometry.type === 'MultiPolygon') {
                feature.geometry.coordinates.forEach(function(polygon, polygonIndex) {
                    polygon.forEach(function(ring, ringIndex) {
                        ring.forEach(function(coord, coordIndex) {
                            var transformed = webMercatorToLatLng(coord[0], coord[1]);
                            transformedData.features[featureIndex].geometry.coordinates[polygonIndex][ringIndex][coordIndex] = transformed;
                        });
                    });
                });
            }
        });
        
        console.log('‚úÖ Coordenadas transformadas');
        console.log('üîç Ejemplo de coordenada transformada:', transformedData.features[0].geometry.coordinates[0][0][0]);
        
        addLayerToMap(transformedData);
    }
    
    // Funci√≥n para agregar la capa al mapa
    function addLayerToMap(data) {
        console.log('‚ûï Agregando capa al mapa...');
        
        // Crear la capa de hex√°gonos
        hexagonosLayer = L.geoJSON(data, {
            style: style,
            onEachFeature: onEachFeature
        }).addTo(map);
        
        console.log('‚úÖ Capa agregada al mapa');
        
        // Obtener bounds de los datos
        var bounds = hexagonosLayer.getBounds();
        console.log('üìè Bounds de los datos:', bounds);
        
        // En lugar de fitBounds, usar un centro personalizado desplazado hacia la izquierda
        // Centrar el mapa en las coordenadas deseadas con zoom reducido
        setTimeout(function() {
            map.setView([-33.39, -70.53], 12); // Desplazado hacia la izquierda con zoom reducido
            console.log('üéØ Vista centrada manualmente en coordenadas espec√≠ficas');
        }, 100);
        
        console.log('üéâ ¬°Hex√°gonos cargados exitosamente!');
    }
    
    // Inicializar mapas cuando la p√°gina est√© cargada
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ DOM cargado, inicializando mapas...');
        initLeafletMap();
    });
  </script>

<!-- Bootstrap 5.3 bundle (unificado) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<!-- Font awesome -->
<script src="https://kit.fontawesome.com/8edb919db8.js" crossorigin="anonymous"></script>
<!-- Script to enable mobile menu on project pages -->
<script src="../pag_proyecto.js" defer></script>
</body>
</html>
