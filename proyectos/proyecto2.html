<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        crossorigin="anonymous">
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="../pag_proyecto.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous" />

    <title>Proyecto 2</title>

    <style>
        .page-wrapper {
            padding-top: 100px;
            padding-bottom: 20px;
        }

        .maps-section {
            display: flex;
            gap: 25px;
            max-width: 1400px;
            margin: 0 auto 25px auto;
            padding: 0 15px;
        }

        .map-column {
            flex: 1;
            min-width: 0;
        }

        .map-container {
            width: 100%;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 0.5rem;
        }

        #leafletMap {
            height: 650px;
            width: 100%;
        }

        .map-title {
            text-align: center;
            font-size: 1.4rem;
            font-weight: 600;
            margin: 0 0 1rem 0;
            color: #333;
            font-family: 'Noto Sans', sans-serif;
        }

        .project-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: center;
        }

        .project-content .project-text {
            width: 100%;
            margin: 0;
            text-align: center;
        }

        .project-content .project-text .indent {
            text-align: justify;
            display: block;
            margin: 0.5rem 0;
        }

        .legend {
            line-height: 20px;
            color: #555;
            background: white;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 12px 16px;
            font: 13px/16px Arial, Helvetica, sans-serif;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            border: 1px solid #ccc;
            min-width: 160px;
        }

        .legend i {
            width: 20px;
            height: 20px;
            float: left;
            margin-right: 10px;
            margin-bottom: 4px;
            opacity: 0.8;
            border: 1px solid #999;
            border-radius: 2px;
        }

        .legend h6 {
            margin: 0 0 8px 0;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            color: #333;
        }

        .legend .legend-item {
            display: block;
            clear: both;
            margin-bottom: 4px;
            font-size: 12px;
            line-height: 20px;
        }

        .opacity-control {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 10px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            border: 1px solid #ccc;
            z-index: 1000;
            font-family: 'Noto Sans', sans-serif;
            min-width: 120px;
        }

        .opacity-control label {
            display: block;
            margin-bottom: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #333;
            text-align: center;
        }

        .opacity-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .opacity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .opacity-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .opacity-value {
            text-align: center;
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }

        @media (max-width: 768px) {
            .page-wrapper {
                padding-top: 70px;
            }

            .maps-section {
                flex-direction: column;
                gap: 30px;
                margin-bottom: 5px;
                padding: 0 10px;
            }
        }
    </style>
</head>

<body>
    <nav class="nav">
        <div class="container">
            <div class="logo">
                <a href="../index.html">Inicio</a>
            </div>
            <div id="mainListDiv" class="main_list">
                <ul class="navlinks">
                    <li><a href="Lucas-Blachet-DelSolar-CV.pdf">CV</a></li>
                    <li><a href="http://www.linkedin.com/in/lucas-blachet/">LinkedIn</a></li>
                    <li><a href="https://github.com/luzarin">GitHub</a></li>
                </ul>
            </div>
            <button id="mobileMenuButton" class="mobile-menu-btn" aria-label="Abrir men√∫">‚ò∞</button>
            <div id="mobileMenu" class="mobile-menu" style="display:none;">
                <ul>
                    <li><a href="Lucas-Blachet-DelSolar-CV.pdf">CV</a></li>
                    <li><a href="http://www.linkedin.com/in/lucas-blachet/">LinkedIn</a></li>
                    <li><a href="https://github.com/luzarin">GitHub</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="page-wrapper">
        <div class="maps-section">
            <div class="map-column">
                <div class="map-title">Visualizaci√≥n 2D</div>
                <div class="map-container" style="position: relative;">
                    <div id="leafletMap"></div>
                    <div class="opacity-control">
                        <label for="leaflet-opacity">Cambiar Transparencia</label>
                        <input type="range" id="leaflet-opacity" class="opacity-slider" min="0" max="100" value="80">
                        <div class="opacity-value" id="leaflet-opacity-value">80%</div>
                    </div>
                </div>
            </div>

            <div class="map-column">
                <div class="map-title">Visualizaci√≥n 3D</div>
                <div class="map-container">
                    <iframe src="proyecto 2/hexagonos_uf_3d.html" width="100%" height="650"
                        style="border: none; border-radius: 6px;"></iframe>
                </div>
            </div>
        </div>

        <div class="project-content">
            <p class="card-text project-text"><span class="coll projdes">Resumen del Proyecto</span><br><span
                    class="indent">Pipeline de extracci√≥n y an√°lisis espacial de datos inmobiliarios de Toc Toc Chile.
                    Permite definir una zona (pol√≠gono Toc Toc), el tipo de propiedad y la operaci√≥n, extraer todas las
                    publicaciones reales usando requests con headers autenticados, consolidar m√∫ltiples descargas en un
                    √∫nico dataset sin duplicados y con una superficie unificada.</span>
                <br>
                <span class="indent">
                    Luego lleva esos datos a una grilla espacial para construir un mapa 3D interactivo en PyDeck donde
                    la altura y el color representan el valor UF/m¬≤ promedio de cada celda. Sirve para an√°lisis
                    exploratorio de mercado, detecci√≥n de zonas con sobreprecio y generaci√≥n r√°pida de entregables web a
                    partir de datos scrapeados.
                </span>
                <br><br>
                <span class="coll projdes">M√°s Informaci√≥n</span>
                <br><br>
                <a href="https://github.com/luzarin/ScrapingTocToc">
                    <span class="logos">üîó GitHub</span>
                </a>
            </p>
        </div>
    </div>

    <footer style="background-color: #111111; padding: 20px 0; text-align: center; margin-top: 40px;">
        <p style="margin: 0; color: #ffffff; font-size: 0.95em;">
            Creado por Lucas Blachet Del Solar | Email: lucas.blachet@uc.cl
        </p>
    </footer>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- JS -->
    <script>
        var map;
        var hexagonosLayer;

        function getColor(valor) {
            if (valor <= 16) {
                return '#fff5f0';
            } else if (valor <= 43) {
                return '#fcbea5';
            } else if (valor <= 68) {
                return '#fb7050';
            } else if (valor <= 126) {
                return '#d32020';
            } else {
                return '#67000d';
            }
        }

        function style(feature) {
            var valor = feature.properties['UF/M2 promedio'] || 0;
            return {
                fillColor: getColor(valor),
                weight: 0.5,
                opacity: 1,
                color: 'white',
                dashArray: '',
                fillOpacity: 0.8
            };
        }

        function highlightFeature(e) {
            var layer = e.target;
            layer.setStyle({
                weight: 3,
                color: '#666',
                dashArray: '',
                fillOpacity: 0.9
            });
            layer.bringToFront();
        }

        function resetHighlight(e) {
            hexagonosLayer.resetStyle(e.target);
        }

        function zoomToFeature(e) {
            var layer = e.target;
            var valor = layer.feature.properties['UF/M2 promedio'] || 0;

            layer.bindPopup(`
            <div style="text-align: center; font-family: 'Noto Sans', sans-serif;">
                <h6 style="margin: 0 0 8px 0; color: #2c3e50;"><strong>Valor UF/M¬≤</strong></h6>
                <p style="font-size: 18px; color: #e74c3c; margin: 0; font-weight: 600;">
                    ${valor.toFixed(2)} UF/M¬≤
                </p>
                <p style="font-size: 12px; color: #7f8c8d; margin: 4px 0 0 0;">
                    GRID ID: ${layer.feature.properties.GRID_ID || 'N/A'}
                </p>
            </div>
        `).openPopup();
        }

        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: zoomToFeature
            });
        }

        function initLeafletMap() {
            map = L.map('leafletMap').setView([-33.4, -70.34], 14);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);


            fetch('proyecto 2/hexagonos_uf.geojson')
                .then(response => {

                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {


                    if (data.features && data.features.length > 0) {

                        var firstCoord = data.features[0].geometry.coordinates[0][0][0];


                        if (Math.abs(firstCoord[0]) > 1000000) {

                            transformAndAddLayer(data);
                        } else {

                            addLayerToMap(data);
                        }
                    } else {
                        console.error('‚ùå No hay features en el GeoJSON');
                    }
                })
                .catch(error => {
                    console.error('üí• Error cargando hex√°gonos:', error);
                    L.marker([-33.4, -70.45]).addTo(map)
                        .bindPopup(`‚ùå Error: ${error.message}<br>Verifica que el archivo hexagonos_uf.geojson est√© en la carpeta proyectos`)
                        .openPopup();
                });

            var legend = L.control({ position: 'bottomright' });

            legend.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'info legend'),
                    grades = [0, 16, 43, 68, 126],
                    labels = [];

                div.innerHTML = '<h6><strong>UF/M¬≤ Promedio</strong></h6>';

                for (var i = 0; i < grades.length; i++) {
                    var rangeText = grades[i] + (grades[i + 1] ? '‚Äì' + grades[i + 1] : '+');
                    div.innerHTML +=
                        '<div class="legend-item">' +
                        '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                        rangeText +
                        '</div>';
                }

                return div;
            };

            legend.addTo(map);

            var opacitySlider = document.getElementById('leaflet-opacity');
            var opacityValue = document.getElementById('leaflet-opacity-value');

            opacitySlider.addEventListener('input', function () {
                var opacity = this.value / 100;
                opacityValue.textContent = this.value + '%';

                if (hexagonosLayer) {
                    hexagonosLayer.setStyle({
                        fillOpacity: opacity
                    });
                }
            });
        }

        function transformAndAddLayer(data) {


            function webMercatorToLatLng(x, y) {
                var lng = x / 20037508.34 * 180;
                var lat = y / 20037508.34 * 180;
                lat = 180 / Math.PI * (2 * Math.atan(Math.exp(lat * Math.PI / 180)) - Math.PI / 2);
                return [lng, lat];
            }

            var transformedData = JSON.parse(JSON.stringify(data));

            transformedData.features.forEach(function (feature, featureIndex) {
                if (feature.geometry.type === 'MultiPolygon') {
                    feature.geometry.coordinates.forEach(function (polygon, polygonIndex) {
                        polygon.forEach(function (ring, ringIndex) {
                            ring.forEach(function (coord, coordIndex) {
                                var transformed = webMercatorToLatLng(coord[0], coord[1]);
                                transformedData.features[featureIndex].geometry.coordinates[polygonIndex][ringIndex][coordIndex] = transformed;
                            });
                        });
                    });
                }
            });



            addLayerToMap(transformedData);
        }

        function addLayerToMap(data) {


            hexagonosLayer = L.geoJSON(data, {
                style: style,
                onEachFeature: onEachFeature
            }).addTo(map);



            var bounds = hexagonosLayer.getBounds();


            setTimeout(function () {
                map.setView([-33.39, -70.53], 12);
            }, 100);


        }

        document.addEventListener('DOMContentLoaded', function () {
            initLeafletMap();
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/8edb919db8.js" crossorigin="anonymous"></script>
    <script src="../pag_proyecto.js" defer="defer"></script>
</body>

</html>